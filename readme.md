# LINE Notify Gateway

### _Node Express server for forwarding Prometheus AlertManager alerts_

Provides a Node docker image running the included Express server.

This server listens for requests from Prometheus Alert Manager, translates the request to be compliant with the [LINE Notify API](https://notify-bot.line.me/doc/en/) and forwards the request to the LINE Notify server.

# Getting Started

1. [Ports](#Ports)
2. [Default Token Configuration](#token-config)
3. [Request Format & Alertmanager Configuration](#request-format)
4. [Running the Server](#running-server)
5. [Adding colors for Severity Levels](#add-colors)

---

#### Ports

This server listens for HTTP requests on port **8080** and HTTPS requests on **8443**

---

<a name="token-config"></a>

#### Default Token Configuration

A default token can optionally be supplied by specifying an envrionmental variable:

```
LINE_TOKEN=<line_token>
```

This default token will be used if one is not supplied in the Alertmanager request headers.

---

<a name="request-format"></a>

#### Request Format & Alertmanager Configuration

The server expects a request from the Prometheus Alertmanager with LINE token specified in the header:

##### Sample Request Headers

```
{
  host: <host>,
  'user-agent': 'Alertmanager/0.26.0',
  'content-length': '894',
  authorization: 'Bearer <line_token>',
  'content-type': 'application/json'
}
```

Such a request can be generated by the following Alertmanager receiver configuration:

##### Sample Alert Configuration

```
webhook_configs:
  - url: <gateway_server_url>
    http_config:
      authorization:
        type: Bearer
        credentials_file: <path_to_credential_file>
```

With such a configuration the LINE token is stored in a credential file:

##### Sample Credential File

```
xjHyPpa8FukJU0EDJpRpP8dzT0G8uEPH13yJZbKnCMG
```

---

<a name="running-server"></a>

#### Running the server

You can run this project in several ways:

---

##### 1. Docker Image

```
docker build -t <ImageTag> .
docker run <ImageTag>
```

---

##### 2. Direct Install in Node Environment

1.  Run `npm install` to install packages
2.  Run `npm start` to start server

---

<a name="add-colors"></a>

#### Adding colors for severity levels

Colors for severity levels are mapped in `src/TextUtils.js`

```
const severityColorLookup = {
  none: () => "ðŸ”µ ",
  warning: () => "ðŸŸ¡ ",
  critical: () => "ðŸ”´ ",
  default: () => "âšª ",
};
```

For other severity levels, add another mapping:

```
const severityColorLookup = {
  none: () => "ðŸ”µ ",
  warning: () => "ðŸŸ¡ ",
  critical: () => "ðŸ”´ ",
  default: () => "âšª ",
  resolved: () => "ðŸŸ¢ "
};
```

![Screenshot](screenshot.png)
